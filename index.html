<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employment & Salary Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <div class="dashboard">
        <h1><i class="fas fa-chart-line"></i> Employment & Salary Analytics Dashboard</h1>
        
        <!-- Controls Panel -->
        <div class="controls-panel">
            <div class="control-group">
                <div class="control-item">
                    <label for="yearSelect"><i class="fas fa-calendar"></i> Analysis Year</label>
                    <select id="yearSelect"></select>
                </div>
                
                <div class="control-item">
                    <label for="universitySelect"><i class="fas fa-university"></i> University Filter</label>
                    <select id="universitySelect">
                        <option value="">All Universities</option>
                    </select>
                </div>
            </div>
            
            <div class="control-group">
                <button onclick="refreshAllCharts()">
                    <i class="fas fa-sync-alt"></i> Refresh All Charts
                </button>
                <button onclick="loadDescriptiveStats()">
                    <i class="fas fa-calculator"></i> Update Statistics
                </button>
            </div>
        </div>
        
        <!-- Statistics Cards -->
        <div class="stats-grid" id="statsGrid">
            <!-- Stats will be populated here -->
        </div>
        
        <!-- Charts Grid -->
        <div class="charts-grid">
            <!-- Descriptive Statistics Chart -->
            <div class="chart-container">
                <h3 class="chart-title"><i class="fas fa-chart-pie"></i> Salary Distribution</h3>
                <div class="chart-canvas">
                    <canvas id="salaryDistChart"></canvas>
                </div>
            </div>
            
            <!-- University Comparison Chart -->
            <div class="chart-container">
                <h3 class="chart-title"><i class="fas fa-university"></i> University Performance Comparison</h3>
                <div class="chart-canvas">
                    <canvas id="universityChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Full-Width Time Series Analysis -->
        <div class="chart-container">
            <h3 class="chart-title"><i class="fas fa-chart-line"></i> Salary Trends Over Time</h3>
            <div class="chart-canvas">
                <canvas id="salaryTrendChart"></canvas>
            </div>
        </div>
        
        <!-- Comparative Analysis Section -->
        <div class="controls-panel">
            <h2 style="color: #1a202c; margin-bottom: 20px; text-align: center;">
                <i class="fas fa-chart-bar"></i> Comparative Analysis & Projections
            </h2>
            <div class="control-group">
                <div class="control-item">
                    <label for="comparisonUniversity"><i class="fas fa-university"></i> Analysis University</label>
                    <select id="comparisonUniversity">
                        <option value="">Select University</option>
                    </select>
                </div>
                
                <div class="control-item">
                    <label for="comparisonDegree"><i class="fas fa-graduation-cap"></i> Degree Program Filter</label>
                    <select id="comparisonDegree">
                        <option value="">All Degree Programs</option>
                    </select>
                </div>
                
                <div class="control-item">
                    <label for="comparisonYear1"><i class="fas fa-balance-scale"></i> Compare Year 1</label>
                    <select id="comparisonYear1"></select>
                </div>
                
                <div class="control-item">
                    <label for="comparisonYear2">Compare Year 2</label>
                    <select id="comparisonYear2"></select>
                </div>
            </div>
            
            <div class="control-group">
                <button onclick="loadComparativeAnalysis()">
                    <i class="fas fa-chart-bar"></i> Run Comparison
                </button>
                <button onclick="loadSalaryProjections()">
                    <i class="fas fa-crystal-ball"></i> Generate Projections
                </button>
            </div>
        </div>
        
        <div class="comparison-grid">
            <div class="comparison-container">
                <h3 class="chart-title"><i class="fas fa-trophy"></i> Top Performing Programs</h3>
                <div class="chart-canvas">
                    <canvas id="topProgramsChart"></canvas>
                </div>
            </div>
            
            <div class="comparison-container">
                <h3 class="chart-title"><i class="fas fa-chart-area"></i> Year-over-Year Comparison</h3>
                <div class="chart-canvas">
                    <canvas id="yearComparisonChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Advanced Analysis Section -->
        <div class="charts-row">
            <div class="chart-container full-width">
                <h3 class="chart-title"><i class="fas fa-crystal-ball"></i> Salary Projections</h3>
                <div class="chart-canvas">
                    <canvas id="projectionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        //Global variables
        let charts = {};
        let currentData = {};
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:5000/analytics'
            : '/analytics';
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeControls();
            loadInitialData();
        });
        
        // Initialize control elements
        async function initializeControls() {
            try {
                // Load years
                const years = await fetch(`${API_BASE}/years`).then(r => r.json());
                const yearSelects = ['yearSelect', 'comparisonYear1', 'comparisonYear2'];
                
                yearSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    select.innerHTML = '';
                    years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        select.appendChild(option);
                    });
                    
                    // Set default values
                    if (selectId === 'yearSelect') {
                        select.value = years[years.length - 1]; // Latest year
                    } else if (selectId === 'comparisonYear1') {
                        select.value = years[years.length - 2] || years[0];
                    } else {
                        select.value = years[years.length - 1];
                    }
                });
                
                // Load universities
                const universities = await fetch(`${API_BASE}/universities`).then(r => r.json());
                
                // Populate main university filter
                const universitySelect = document.getElementById('universitySelect');
                universities.forEach(uni => {
                    const option = document.createElement('option');
                    option.value = uni;
                    option.textContent = uni;
                    universitySelect.appendChild(option);
                });
                
                // Populate comparison university filter
                const comparisonUniversitySelect = document.getElementById('comparisonUniversity');
                universities.forEach(uni => {
                    const option = document.createElement('option');
                    option.value = uni;
                    option.textContent = uni;
                    comparisonUniversitySelect.appendChild(option);
                });
                
                // Add event listener for comparison university to load degree programs
                comparisonUniversitySelect.addEventListener('change', loadDegreesForUniversity);
                
            } catch (error) {
                console.error('Error initializing controls:', error);
            }
        }
        
        // Load degree programs for selected university
        async function loadDegreesForUniversity() {
            const university = document.getElementById('comparisonUniversity').value;
            const degreeSelect = document.getElementById('comparisonDegree');
            
            console.log('Loading degree programs for university:', university);
            
            // Clear existing options
            degreeSelect.innerHTML = '<option value="">All Degree Programs</option>';
            
            if (university) {
                try {
                    const url = `${API_BASE}/degrees/${encodeURIComponent(university)}`;
                    console.log('Fetching degrees from:', url);
                    
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const degrees = await response.json();
                    console.log('Received degree programs:', degrees);
                    
                    if (degrees && degrees.length > 0) {
                        degrees.forEach(degree => {
                            const option = document.createElement('option');
                            option.value = degree;
                            option.textContent = degree;
                            degreeSelect.appendChild(option);
                        });
                        console.log(`Added ${degrees.length} degree programs to dropdown`);
                    } else {
                        console.log('No degree programs found for university:', university);
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'No degree programs found';
                        option.disabled = true;
                        degreeSelect.appendChild(option);
                    }
                } catch (error) {
                    console.error('Error loading degree programs:', error);
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Error loading degree programs';
                    option.disabled = true;
                    degreeSelect.appendChild(option);
                }
            }
        }
                
        
        // Load initial data
        async function loadInitialData() {
            await loadDescriptiveStats();
            await loadUniversityComparison();
            await loadSalaryTrends();
            await loadSalaryDistribution();
            await loadTopPrograms();
        }
        
        // Load descriptive statistics
        async function loadDescriptiveStats() {
            try {
                const year = document.getElementById('yearSelect').value;
                const university = document.getElementById('universitySelect').value;
                
                let url = `${API_BASE}/descriptive_stats?year=${year}`;
                if (university) {
                    url += `&university=${encodeURIComponent(university)}`;
                }
                
                const stats = await fetch(url).then(r => r.json());
                
                // Create subtitle for filtering context
                const filterText = university ? ` (${university} - ${year})` : ` (All Universities - ${year})`;
                
                const statsHtml = `
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-dollar-sign"></i></div>
                        <div class="stat-value">$${Math.round(stats.avg_salary || 0).toLocaleString()}</div>
                        <div class="stat-label">Average Salary${filterText}</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-briefcase"></i></div>
                        <div class="stat-value">${(stats.avg_employment_rate || 0).toFixed(1)}%</div>
                        <div class="stat-label">Avg Employment Rate${filterText}</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                        <div class="stat-value">$${Math.round(stats.max_salary || 0).toLocaleString()}</div>
                        <div class="stat-label">Highest Salary${filterText}</div>
                    </div>
                `;
                
                document.getElementById('statsGrid').innerHTML = statsHtml;
                
            } catch (error) {
                console.error('Error loading descriptive stats:', error);
            }
        }
        
        // Load salary distribution
        async function loadSalaryDistribution() {
            try {
                const year = document.getElementById('yearSelect').value;
                const data = await fetch(`${API_BASE}/salary_distribution/${year}`).then(r => r.json());
                
                const ctx = document.getElementById('salaryDistChart').getContext('2d');
                
                if (charts.salaryDist) charts.salaryDist.destroy();
                
                charts.salaryDist = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.map(d => d.salary_range),
                        datasets: [{
                            data: data.map(d => d.count),
                            backgroundColor: [
                                '#FF6B6B', '#4ECDC4', '#45B7D1', 
                                '#96CEB4', '#FFEAA7', '#DDA0DD'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true
                                }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error loading salary distribution:', error);
            }
        }
        
        // Load university comparison
        async function loadUniversityComparison() {
            try {
                const year = document.getElementById('yearSelect').value;
                const data = await fetch(`${API_BASE}/university_comparison?year=${year}`).then(r => r.json());
                
                const ctx = document.getElementById('universityChart').getContext('2d');
                
                if (charts.university) charts.university.destroy();
                
                charts.university = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(d => d.university_name),
                        datasets: [
                            {
                                label: 'Average Salary ($)',
                                data: data.map(d => d.avg_salary),
                                backgroundColor: 'rgba(102, 126, 234, 0.8)',
                                yAxisID: 'y'
                            },
                            {
                                label: 'Employment Rate (%)',
                                data: data.map(d => d.avg_employment_rate),
                                backgroundColor: 'rgba(255, 107, 107, 0.8)',
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: { display: true, text: 'Salary ($)' }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: { display: true, text: 'Employment Rate (%)' },
                                grid: { drawOnChartArea: false },
                                max: 100
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error loading university comparison:', error);
            }
        }
        
        // Load salary trends
        async function loadSalaryTrends() {
            try {
                const data = await fetch(`${API_BASE}/salary_trends`).then(r => r.json());
                
                // Group data by university
                const groupedData = {};
                data.forEach(item => {
                    if (!groupedData[item.university_name]) {
                        groupedData[item.university_name] = [];
                    }
                    groupedData[item.university_name].push({
                        x: item.year,
                        y: item.avg_salary
                    });
                });
                
                const ctx = document.getElementById('salaryTrendChart').getContext('2d');
                
                if (charts.salaryTrend) charts.salaryTrend.destroy();
                
                const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD'];
                const datasets = Object.keys(groupedData).map((university, index) => ({
                    label: university,
                    data: groupedData[university],
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4
                }));
                
                charts.salaryTrend = new Chart(ctx, {
                    type: 'line',
                    data: { datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'linear',
                                title: { display: true, text: 'Year' }
                            },
                            y: {
                                title: { display: true, text: 'Average Salary ($)' }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error loading salary trends:', error);
            }
        }
        
        // Load employment trends
        
        // Load top performing programs
        async function loadTopPrograms() {
            try {
                const year = document.getElementById('yearSelect').value;
                const university = document.getElementById('universitySelect').value;
                console.log('Loading top programs for year:', year, 'university:', university);
                
                let url = `${API_BASE}/top_performing_programs?year=${year}&limit=8`;
                if (university) {
                    url += `&university=${encodeURIComponent(university)}`;
                }
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Top programs data:', data);
                
                if (!data || data.length === 0) {
                    console.warn('No data returned for top programs');
                    // Update chart title to show no data
                    const container = document.getElementById('topProgramsChart').closest('.comparison-container');
                    const titleElement = container.querySelector('.chart-title');
                    const universityText = university ? ` - ${university}` : '';
                    titleElement.innerHTML = `<i class="fas fa-trophy"></i> Top Performing Programs${universityText} <span style="color: #718096; font-size: 0.8em;">(No data available)</span>`;
                    return;
                }
                
                // Update chart title
                const container = document.getElementById('topProgramsChart').closest('.comparison-container');
                const titleElement = container.querySelector('.chart-title');
                const universityText = university ? ` - ${university}` : '';
                titleElement.innerHTML = `<i class="fas fa-trophy"></i> Top Performing Programs${universityText}`;
                
                const ctx = document.getElementById('topProgramsChart').getContext('2d');
                
                if (charts.topPrograms) charts.topPrograms.destroy();
                
                charts.topPrograms = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(d => `${d.university_name.substring(0, 20)}...\n${d.degree_name.substring(0, 30)}...`),
                        datasets: [{
                            label: 'Performance Score',
                            data: data.map(d => d.performance_score),
                            backgroundColor: 'rgba(118, 75, 162, 0.8)',
                            borderColor: 'rgba(118, 75, 162, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return data[context[0].dataIndex].university_name;
                                    },
                                    label: function(context) {
                                        const item = data[context.dataIndex];
                                        return [
                                            `Program: ${item.degree_name}`,
                                            `School: ${item.school_name}`,
                                            `Salary: $${Math.round(item.salary).toLocaleString()}`,
                                            `Employment Rate: ${item.employment_rate.toFixed(1)}%`,
                                            `Performance Score: ${Math.round(item.performance_score)}`
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Performance Score' }
                            },
                            y: {
                                title: { display: true, text: 'Programs' }
                            }
                        }
                    }
                });
                
                console.log('Top programs chart created successfully');
                
            } catch (error) {
                console.error('Error loading top programs:', error);
                document.getElementById('topProgramsChart').parentElement.innerHTML = 
                    '<div class="error">Error loading top programs data. Please check the console for details.</div>';
            }
        }
        
        // Load comparative analysis
        async function loadComparativeAnalysis() {
            try {
                const year1 = document.getElementById('comparisonYear1').value;
                const year2 = document.getElementById('comparisonYear2').value;
                
                const data = await fetch(`${API_BASE}/year_comparison/${year1}/${year2}`).then(r => r.json());
                
                const ctx = document.getElementById('yearComparisonChart').getContext('2d');
                
                if (charts.yearComparison) charts.yearComparison.destroy();
                
                charts.yearComparison = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [
                            {
                                label: `${year1} vs ${year2} Salary Comparison`,
                                data: data.map(d => ({
                                    x: d.salary_year1,
                                    y: d.salary_year2,
                                    label: d.university_name
                                })),
                                backgroundColor: 'rgba(102, 126, 234, 0.6)',
                                borderColor: 'rgba(102, 126, 234, 1)',
                                borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { title: { display: true, text: `${year1} Salary ($)` } },
                            y: { title: { display: true, text: `${year2} Salary ($)` } }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const point = context.parsed;
                                        const change = ((point.y - point.x) / point.x * 100).toFixed(1);
                                        return [
                                            `${data[context.dataIndex].university_name}`,
                                            `${year1}: $${Math.round(point.x).toLocaleString()}`,
                                            `${year2}: $${Math.round(point.y).toLocaleString()}`,
                                            `Change: ${change}%`
                                        ];
                                    }
                                }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error loading comparative analysis:', error);
            }
        }
        
        // Load salary projections for selected university
        async function loadSalaryProjections() {
            const university = document.getElementById('comparisonUniversity').value;
            if (!university) {
                alert('Please select a university for projections');
                return;
            }
            
            try {
                const data = await fetch(`${API_BASE}/salary_projection/${encodeURIComponent(university)}`).then(r => r.json());
                
                const ctx = document.getElementById('projectionChart').getContext('2d');
                
                if (charts.projection) charts.projection.destroy();
                
                if (data.projections && data.projections.length > 0) {
                    const historicalData = data.historical_data.map(d => ({
                        x: d.year,
                        y: d.avg_salary
                    }));
                    
                    const projectionData = data.projections.map(d => ({
                        x: d.year,
                        y: d.projected_salary
                    }));
                    
                    charts.projection = new Chart(ctx, {
                        type: 'line',
                        data: {
                            datasets: [
                                {
                                    label: 'Historical Data',
                                    data: historicalData,
                                    borderColor: '#4ECDC4',
                                    backgroundColor: 'rgba(78, 205, 196, 0.1)',
                                    borderWidth: 3,
                                    fill: false
                                },
                                {
                                    label: 'Projections',
                                    data: projectionData,
                                    borderColor: '#FF6B6B',
                                    backgroundColor: 'rgba(255, 107, 107, 0.1)',
                                    borderWidth: 3,
                                    borderDash: [10, 5],
                                    fill: false
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    type: 'linear',
                                    title: { display: true, text: 'Year' }
                                },
                                y: {
                                    title: { display: true, text: 'Average Salary ($)' }
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: `${university} - Salary Trend & Projections`
                                }
                            }
                        }
                    });
                } else {
                    document.getElementById('projectionChart').parentElement.innerHTML = 
                        '<div class="loading">Insufficient data for salary projections.</div>';
                }
                
            } catch (error) {
                console.error('Error loading salary projections:', error);
                document.getElementById('projectionChart').parentElement.innerHTML = 
                    '<div class="error">Error loading projection data.</div>';
            }
        }
        
        // Load degree performance analysis
        
        // Refresh all charts
        function refreshAllCharts() {
            loadInitialData();
            
            // Only load comparative analysis if comparison years are selected
            const year1 = document.getElementById('comparisonYear1').value;
            const year2 = document.getElementById('comparisonYear2').value;
            if (year1 && year2) {
                loadComparativeAnalysis();
            }
        }
        
        // Event listeners
        document.getElementById('yearSelect').addEventListener('change', function() {
            loadDescriptiveStats();
            loadUniversityComparison();
            loadSalaryDistribution();
            loadTopPrograms();
        });
        
        document.getElementById('universitySelect').addEventListener('change', function() {
            loadTopPrograms();
            loadDescriptiveStats();
        });
        
        document.getElementById('comparisonYear1').addEventListener('change', loadComparativeAnalysis);
        document.getElementById('comparisonYear2').addEventListener('change', loadComparativeAnalysis);
    </script>
</body>
</html>
